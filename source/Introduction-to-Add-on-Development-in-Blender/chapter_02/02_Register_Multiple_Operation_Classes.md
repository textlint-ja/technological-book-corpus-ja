<div id="sect_title_img_2_2"></div>

<div id="sect_title_text"></div>

# 複数のオペレータクラスを登録する

<div id="preface"></div>

###### [2-1節](01_Basic_of_Add-on_Development.md) ではアドオン開発の基本的な部分について説明しました。本節では前回解説した内容を理解していることを前提に、[2-1節](01_Basic_of_Add-on_Development.md) よりも複雑なサンプルを用いて、複数のメニュー項目を追加する方法を解説します。既に解説済みの部分は説明を省略しますので、不明な点がある場合は [2-1節](01_Basic_of_Add-on_Development.md) に戻って確認してください。

## 作成するアドオンの仕様

本節で作成するアドオンの仕様は以下の通りです。

* *3Dビュー* エリアのメニューである *オブジェクト* に *選択オブジェクトの拡大* と *選択オブジェクトの縮小* を追加
* *オブジェクト* > *選択オブジェクトの拡大* を実行すると、選択中のオブジェクトの大きさが2倍になる
* *オブジェクト* > *選択オブジェクトの縮小* を実行すると、選択中のオブジェクトの大きさが1/2倍になる

## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードを入力し、ファイル名 ```sample_2-2.py``` で保存します。

[import](../../sample/src/chapter_02/sample_2-2.py)


## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして、作成したアドオンを有効化します。

アドオンが有効化されると、コンソールウィンドウに以下の文字列が出力されるはずです。

```sh
サンプル2-2: アドオン「サンプル2-2」が有効化されました。
```

<div id="sidebyside"></div>

|アドオン有効化後、右図のように *3Dビュー* エリアのメニューに *オブジェクト* > *選択オブジェクトの拡大* と、*オブジェクト* > *選択オブジェクトの縮小* が追加されていることを確認します。|![メニューの追加確認](https://dl.dropboxusercontent.com/s/udxtkxqkbrbj4hz/enable_add-on.png "メニューの追加確認")|
|---|---|


### アドオンの機能を使用する

以下の手順に従い、作成したアドオンの機能を使ってみます。


<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|Blender起動直後に自動的に生成されているオブジェクト *Cube* を選択し、*3Dビュー* エリアのメニューである、*オブジェクト* > *選択オブジェクトの拡大* を実行します。<br>選択したオブジェクト *Cube* のサイズが2倍に拡大されます。|![選択オブジェクトの拡大](https://dl.dropboxusercontent.com/s/ll5jtxlmj5vek96/use_add-on_1.png "選択オブジェクトの拡大")|
|---|---|---|

この時、スクリプト実行ログには以下のメッセージが出力されます。

```sh
サンプル2-2: 「Cube」を2倍に拡大しました。
```

また、コンソールウィンドウにも以下のメッセージが出力されます。

```sh
サンプル2-2: オペレーション「OBJECT_OT_enlarge_object」が実行されました。
```

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*情報* エリアのメニューである、*ファイル* > *新規* を実行し、*スタートアップファイルの再読み込み* を行った後、*3Dビュー* エリアのメニューである、*オブジェクト* > *選択オブジェクトの縮小* を実行します。<br>選択中のオブジェクト *Cube* のサイズが1/2倍に縮小されます。|![選択オブジェクトの縮小](https://dl.dropboxusercontent.com/s/zinqogsgx4td6jw/use_add-on_2.png "選択オブジェクトの縮小")|
|---|---|---|

この時、スクリプト実行ログには以下のメッセージが出力されます。

```sh
サンプル2-2: 「Cube」を1/2倍に縮小しました。
```

また、コンソールウィンドウには以下のメッセージが出力されます。

```sh
サンプル2-2: オペレーション「OBJECT_OT_reduce_object」が実行されました。
```

<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に、有効化したアドオンを無効化します。

アドオンを無効化すると、コンソールウィンドウに以下の文字列が出力されます。

```sh
サンプル2-2: アドオン「サンプル2-2」が無効化されました。
```

## ソースコードの解説

アドオンの動作を確認したところで、次にソースコードの解説をします。ここでは、前節で説明した内容から新しく追加された部分について説明します。

### 複数のオペレータクラスの定義

本節で新たに加わった処理の1つとして、複数のオペレータクラスを定義する処理があります。

1つのファイルに複数のオペレータクラスを定義するためには、**作りたい機能の数だけオペレーションクラスを定義する** 必要があります。本節のサンプルでは、オブジェクトの拡大とオブジェクトの縮小の2つの機能のために、2つのオペーレーションクラスを以下のように作成しました。

[import:"op_enlarge_object"](../../sample_raw/src/chapter_02/sample_2-2.py)

[import:"op_reduce_object"](../../sample_raw/src/chapter_02/sample_2-2.py)


```bl_idname``` はオペレータクラスごとに固有の文字列を指定する必要があるため、重複しないように気をつけてください。重複しないようにするための方法は、後ほど紹介します。

### スクリプト実行ログへの出力

オペレータクラスの ```execute()``` メソッドの処理の中には、メニューが実行された時にスクリプト実行ログへメッセージを出力する処理が含まれています。

ここでは、```EnlargeObject``` クラスの ```execute()``` メソッド内に定義されている、スクリプト実行ログへメッセージを出力する処理について説明します。

[import:"execute_enlarge_object", unindent:"true"](../../sample_raw/src/chapter_02/sample_2-2.py)

```execute()``` メソッドに渡されてくる引数については、[2-1節](01_Basic_of_Add-on_Development.md) で説明しましたので、引数の詳細についての説明はここでは省略します。引数 ```context``` から、現在のコンテキスト（実行状態）を取得することができます。

現在選択されているオブジェクトである ```context.active_object``` を ```active_obj``` に一度保存し、 ```active_obj.scale``` を2倍にすることで取得したオブジェクトのサイズを2倍に拡大することができます。

その後 ```self.report()``` メソッドを用いて、ユーザに対してオペレーションを実行した後に、オブジェクトを拡大・縮小したことがわかるようなメッセージをスクリプト実行ログに出力します。ここで、```execute()``` メソッドの引数である ```self``` は、オブジェクトのインスタンスです。

```self.report()``` メソッドに指定する必要のある引数を以下に示します。

|引数|型|値の説明|
|---|---|---|
|第1引数|集合型|出力メッセージの種類|
|第2引数|文字列|メッセージ本文|

表示したいメッセージの内容に応じてメッセージの種類を指定し、スクリプト実行ログへ出力することができます。出力メッセージの種類には例えば以下のようなものがあります。

|種類|コンソールウィンドウ<br>への出力|情報ウィンドウの<br>メニューへの出力|利用場面|
|---|---|---|---|
|```INFO```|ハイライト表示<br>（緑色）|通知メッセージ|オペレーションの成功通知やオペレーションにより変化した内容の通知など、参考程度の情報をユーザへ通知したい場合|
|```WARNING```|ハイライト表示<br>（橙色）|警告メッセージ|アドオンの実行条件に合わない時など、ユーザに注意を促したい情報を通知したい場合|
|```ERROR```|ハイライト表示<br>（赤色）|エラーメッセージ|アドオンの実行に失敗した時の通知や本来起こらないはずのエラーが発生した時など、ユーザが特に注意を払ってほしい情報を通知したい場合|
|```OPERATOR```|表示|（なし）|エラー発生時に、開発者へフィードバックするためのアドオンの内部情報を表示したい場合|

本節のサンプルでは、オブジェクトが拡大・縮小されたことをユーザへ知らせるために ```{'INFO'}``` を指定し、拡大・縮小したオブジェクト名（ ```active_obj.name``` ）も表示しています。

## Pythonコンソールを活用しよう

### bl_idname が重複していないかを確認する

```bl_idname``` が重複してはならないと説明しましたが、```bl_idname``` が重複していないかを確認するためにはどのようにしたら良いのでしょうか？すでに存在する ```bl_idname``` を確認したい時に役に立つのが、Pythonコンソールです。

Pythonコンソールを利用することにより、例えば以下のようなことができます。

* 補完機能を使って、APIの正確な名称を調べることができる
* APIを実行することで、APIの効果を確認出来る
* 短いPythonのソースコードを実行し、簡単なテストができる
* アドオン作成時に命名した関数などが、APIや他のアドオンと重複していないかを確認出来る

ここではPythonコンソールを使って、本節のサンプルで追加したオペレータクラスの ```bl_idname``` が既存のAPIと重複していないかを実際に確認してみます。確認対象とする ```bl_idname``` は ```object.enlarge_object``` とします。

Blenderのエリア構成が [1-3節](../chapter_01/03_Prepare_Add-on_development_environment.md) で紹介したような設定となっていれば、左上のウィンドウが *Pythonコンソール* エリアとなります。


<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|設定したオペレータクラスの ```bl_idname``` が ```bpy.ops.<オペレーションクラスのbl_idname>``` に登録されることを利用します。<br>*Pythonコンソール* エリアに ```bpy.ops.object.enlarge_obje``` と入力してみます。入力が完了したら、WindowsやLinuxであれば *Ctrl* + *Space* 、Macであれば *control* + *space* を押します。ここで単語が補完されなければ、```bl_idname``` として ```bpy.ops.object.enlarge_object``` が利用されていないことになり、```bl_idname``` への指定が可能であることがわかります。|![Pythonコンソール 使い道 手順1](https://dl.dropboxusercontent.com/s/xazuoclt1k0y4t7/python_console_1.png "Pythonコンソール 使い道1")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|本節で作成したアドオンを有効化した後に、Pythonコンソールに以下を打ち込んで *Enter* キーを押します。|![Pythonコンソール 使い道 手順2](https://dl.dropboxusercontent.com/s/rxa9lx8uk12ytoq/python_console_2.png "Pythonコンソール 使い道 手順2")|
|---|---|---|

```python
>>> bpy.ops.object.enlarge_object()
```

*3Dビュー* エリアのメニューである、*オブジェクト* > *選択オブジェクトの拡大* を実行した時と同様の効果が得られます。このようにオペレータクラスを登録すると、オペレータクラスの ```bl_idname``` が ```bpy.ops.<オペレーションクラスのbl_idname>``` として登録されることがわかります。

<div id="process_start_end"></div>

---


### Pythonコンソールのショートカットキー

*Pythonコンソール* エリアではショートカットキーが利用できますので、作業効率化のためにぜひ活用してください。

|Windows|Mac|Linux|動作|
|----|----|----|----|
|Shift + F4|shift + fn + F4|Shift + F4|Python Consoleを開く|
|↑|↑|↑|過去に入力した履歴を戻る|
|↓|↓|↓|過去に入力した履歴を進める|
|Tab|tab|Tab|インデント|
|Shift + tab|shift + tab|shift + tab|アンインデント|
|Home|⌘ + ←|Home|行頭にカーソルを移動|
|End|⌘ + →|End|行末にカーソルを移動|
|Ctrl + ←|control + ←<br>fn + ←|Ctrl + ←|単語単位で左にカーソルを移動|
|Ctrl + →|control + →<br>fn + →|Ctrl + →|単語単位で右にカーソルを移動|
|Ctrl + Backspace|control + delete|Ctrl + Backspace|カーソルの位置から行頭に向かって単語単位で削除|
|Ctrl + Delete|control + fn + delete|Ctrl + Delete|カーソルの位置から行末に向かって単語単位で削除|
|Shift + Enter|shift + return|Shift + Enter|行を削除|
|Ctrl + Space|control + space|Ctrl + Space|ソースコード補完|
|Ctrl + ↑<br>Ctrl + ↓|control + ↑<br>control + ↓|Ctrl + ↑<br>Ctrl + ↓|コンソールウィンドウのフルスクリーン化/解除|
|Ctrl + C|control + C|Ctrl + C|選択部分をクリップボードへコピー|
|Ctrl + V|control + V|Ctrl + V|クリップボードからの貼り付け|
|Shift + Ctrl + C|shift + control + C|Shift + Ctrl + C|Python Consoleで実行されたスクリプトを全てコピー<br>実行結果についてもコピーされるが、行頭に「#~ 」が自動的についてコメント化される|
※ ⌘はMacのcommandを指す

Macでショートカットキーを利用するためには、Macのショートカットキーに標準で割り当てられているcontrolと⌘キーについて、以下の手順に沿って割り当てを解除する必要があります。

<div id="process_title"></div>

##### Work

<div id="process_noimg"></div>

|<div id="box">1</div>|*システム環境設定...* をクリック|
|---|---|

<div id="process_sep"></div>

---

<div id="process_noimg"></div>

|<div id="box">2</div>|*キーボード* をクリック|
|---|---|

<div id="process_sep"></div>

---

<div id="process_noimg"></div>

|<div id="box">3</div>|*ショートカットタブ* をクリック|
|---|---|

<div id="process_sep"></div>

---

<div id="process_noimg"></div>

|<div id="box">4</div>|*Pythonコンソール* で使いたいショートカットキーの割り当てを解除|
|---|---|

<div id="process_start_end"></div>

---

## まとめ

本節では、複数のオペレータクラスを作る方法やスクリプト実行ログにメッセージを出力する方法を紹介しました。さらに、Pythonコンソールの利用方法を紹介しました。Pythonコンソールを利用することでAPIやテストしたい処理を直接実行して動作確認できることから、アドオン開発の効率化のために積極的に活用していきましょう。


<div id="space_xs"></div>


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* オペレーションを複数作るためには、作りたいオペレーションの数だけオペレータクラスを定義する必要がある
* ```self.report()``` メソッドを利用することで、スクリプト実行ログにメッセージを出力することができる
* 登録したオペレータクラスの ```bl_idname``` は ```bpy.ops.<bl_idname>``` に登録される
* Pythonコンソールを利用して、APIの確認や簡単なテストを行うことができる
