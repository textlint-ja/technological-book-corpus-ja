<div id="sect_title_img_3_10"></div>

<div id="sect_title_text"></div>

# ユーザー・プリファレンスを活用する

<div id="preface"></div>

###### ユーザはアドオンごとに提供される設定をユーザー・プリファレンスから変更することができます。アドオンで使用するキーボードのキーやUIのフォントなどのユーザに設定させたい情報をユーザー・プリファレンスに配置することで、プロパティパネルなどの既存のUIの邪魔にならないようにできます。本節では、ユーザー・プリファレンスからアドオンの設定を行うための方法を説明します。


## ユーザー・プリファレンス

### ユーザー・プリファレンスにおけるアドオン設定

ユーザー・プリファレンスとは、*情報* エリアのメニューから、*ファイル* > *ユーザー設定...* から開くことのできるウィンドウのことを指します。これまでの節では、ユーザー・プリファレンスを使ってBlenderのUIを日本語化したりアドオンの有効/無効化を行ったりしてきました。本節では、ユーザー・プリファレンスのアドオンに関連する話題として、アドオンの設定情報をユーザー・プリファレンスに配置する方法を説明します。

具体的なサンプルの説明に入る前に、ユーザー・プリファレンスにてアドオンの設定をどこで参照＆設定することができるのかを知る必要があります。ここでは、筆者が作成したアドオン『Magic UV』を使って確認します。アドオン『Magic UV』は、https://github.com/nutti/Magic-UV/releases/download/v4.0/uv_magic_uv.zip からダウンロードすることができます。


<div id="process_title"></div>

##### Work

<div id="process_noimg"></div>

|<div id="box">1</div>|[1-4節](../chapter_01/04_Understand_Install_Uninstall_Update_Add-on.md) のインストール方法2に従ってアドオンをインストールします。|
|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*情報* エリアの *ファイル* > *ユーザ設定...* を実行して表示されるユーザー・プリファレンスで *アドオン* タブを選択し、『Magic UV』を有効化した状態で左の矢印をクリックしてアドオンの詳細情報を表示します。*ユーザ設定:* と書かれたところが、本節で説明するアドオンの設定情報になります。|![3-10節 ユーザー・プリファレンス 手順1](https://dl.dropboxusercontent.com/s/q64ns5ju4lh7dut/user_preferences_2.png "3-10節 ユーザー・プリファレンス 手順1")|
|---|---|---|

<div id="process_sep"></div>

---



<div id="process_start_end"></div>

---


### ユーザー・プリファレンスに追加すべきアドオン設定

これまで説明してきたように、ユーザがアドオンの動作を変更するためのUIはツール・シェルフやプロパティパネルに配置してもよいです。しかし、全てのアドオンの設定をツール・シェルフやプロパティパネルに配置することはUIが煩雑になるため、良い選択とは言えません。このためツール・シェルフやプロパティパネルに配置する設定情報は、頻繁に変更する設定のみとし、その他はアドオンの設定に配置するなど使い分けることが大切です。アドオンの設定として追加すべき項目の例を以下に示します。

* アドオンが複数の機能で構成される時の、アドオン内の機能の有効化/無効化
* アドオンの機能に割り当てるショートカットキー
* フォントなどのアドオンのUI設定
* 文字数の関係上、```bl_info``` に記載できなかったアドオンの詳細情報（特に ```location``` や ```description```）
* アドオンが複数の機能で構成される時にアドオン全体で共有したい設定

本節で説明するアドオンは、上から2番目の用途でユーザー・プリファレンスに設定情報を配置します。


## 作成するアドオンの仕様

* [3-2節](02_Handle_Keyboard_Key_Event.md) のサンプルを改造し、使用するキーをアドオンのユーザ設定から選択できるようにする
* 使用するキーを重複して設定することも可能
  * 例：X軸とY軸に *X* キーを割り当てると、*X* キーを押した時にX軸とY軸の正の方向へ同時に移動する


## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-10.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-10.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-10: アドオン「サンプル3-10」が有効化されました。
```

<div id="sidebyside"></div>

|アドオンを有効化すると、右図のようにアドオンの設定が表示されます。|![3-10節 アドオン有効化](https://dl.dropboxusercontent.com/s/i55wbm2zo8kw4gj/enable_add-on.png "3-10節 アドオン有効化")|
|---|---|


### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。


<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|アドオンの設定から、機能に割り当てられているキーを変更します。|![3-10節 アドオンの使用 手順1](https://dl.dropboxusercontent.com/s/8m52ds2soblqkpt/use_add-on_1.png "3-10節 アドオンの使用 手順1")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|[3-2節](02_Handle_Keyboard_Key_Event.md) の機能が、1で割り当てたキーで動作することを確認します。キーを重複して登録した時は、登録した軸の正方向に同時に移動することができます。|![3-10節 アドオンの使用 手順2](https://dl.dropboxusercontent.com/s/pcywxf28gtja619/use_add-on_2.png "3-10節 アドオンの使用 手順2")|
|---|---|---|


<div id="process_sep"></div>

---

<div id="process_noimg"></div>

|<div id="box">3</div>|*Q* キーを押すと、オブジェクト並進移動モードが終了します。|
|---|---|


<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-10: アドオン「サンプル3-10」が無効化されました。
```



## ソースコードの解説

ユーザー・プリファレンスにアドオンの設定情報を追加し、アドオンの動作に反映させるためには以下の処理を実装する必要があります。

1. アドオン設定クラスを定義する
2. アドオン設定クラスに定義した設定情報を取得する

### アドオン設定クラスを定義する

ユーザー・プリファレンスにアドオンの設定情報を追加するためには、```bpy.types.AddonPreferences``` クラスを継承したクラス（アドオン設定クラスと呼ぶことにします）を定義する必要があります。

[import:"addon_prefs", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-10.py)

アドオン設定クラスのメンバ変数 ```bl_idname``` には、ユーザー・プリファレンスにアドオンの設定情報を追加するパッケージ名やモジュール名を指定します。ユーザー・プリファレンスに追加するアドオンの設定情報は、プロパティクラスとしてメンバ変数に定義します。アドオンが単一のファイルで構成される場合は、自身のモジュール名を表す ```__name__``` を指定します。一方、アドオンが複数のファイルで構成される場合にはパッケージ名を指定する必要がありますが、1点注意が必要です。アドオン設定クラスが ```__init__.py``` に定義されている場合は、```__name__``` がパッケージ名を表すため ```__name__``` を指定すれば問題ありませんが、```__init__.py``` 以外に定義されている場合はパッケージ名を表す ```__package__``` を指定する必要があります。

<div id="tips"></div>

アドオン設定クラスのメンバ変数 ```bl_idname``` には、すでにインストール済みの他のアドオンのパッケージ名やモジュール名を指定することができます。この場合、アドオンを有効化すると、```bl_idname``` に指定したパッケージ名を持つアドオンの設定情報に、アドオン設定クラスで定義した設定情報が表示されます。（```bl_idname``` に指定した表示先のアドオンと、アドオン設定クラスを定義したアドオンの両方が有効化されている必要があることに注意が必要です。）  
例えば、Blenderに標準搭載されている（サポートレベルがOfficialである）アドオンである「UV Layout」に設定情報を表示するためには、「UV Layout」のパッケージ名が ```io_mesh_uv_layout``` であることから、```bl_idname = 'io_mesh_uv_layout'``` と指定します。


アドオン設定クラスの ```draw()``` メソッドには、ユーザー・プリファレンスに追加するアドオンの設定情報のUIを構築するための処理を追加します。```draw()``` メソッドで記述する処理は、これまでパネルクラスやツール・シェルフのオプションのUIを構築するためにオペレータクラスに実装してきた ```draw()``` メソッドと書き方自体は同じですので、ここでは説明を省略します。

### アドオン設定クラスに定義した設定情報を取得する

アドオン設定クラスにプロパティクラスをメンバ変数に定義することで、ユーザー・プリファレンスにアドオンの設定情報を追加することができました。続いて、アドオンの処理でユーザが設定した設定情報を取得する必要があります。本節のサンプルでは、以下の処理によりアドオン設定クラスに定義した設定情報を取得します。

[import:"get_prefs", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-10.py)

ユーザー・プリファレンスに追加された全てのアドオンの設定情報は、```context.user_preferences.addons``` にパッケージ名やモジュール名をキーとした辞書型で保存されていて、設定情報は ```preferences``` から参照することができます。本節のサンプルは単一ファイルで構成され、かつ自分自身のアドオンの設定情報を取得するため、```context.user_preferences.addons[__name__].preferences``` で取得することができます。仮にアドオンが複数のファイルで構成されている場合は ```bl_idname``` の時と同様、```__init__.py``` の場合は、```context.user_preferences.addons[__name__].preferences``` 、それ以外の場合は ```context.user_preferences.addons[__package__].preferences``` のように指定することでアドオンの設定情報を取得できます。

取得したアドオンの設定情報は、アドオン設定クラスで定義したメンバ変数 ```x_axis``` であれば ```context.user_preferences.addons[__name__].x_asis``` のように取得することができます。最後にアドオンの設定情報を使ってオブジェクトを移動する処理を次に示します。

[import:"get_prefs", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-10.py)

```event.type``` の判定にアドオンの設定情報を用いていることを除いては、[3-2節](02_Handle_Keyboard_Key_Event.md) と同じですので、説明は省略します。

## まとめ

ユーザー・プリファレンスにアドオンの設定情報を配置し、ユーザから設定された情報を取得する方法を紹介しました。ユーザー・プリファレンスを活用することで、プロパティやツール・シェルフに設定情報が多くなりすぎて見づらくなるという問題を解消することができます。ユーザー・プリファレンスに配置する設定情報を選択する基準を決めるのはなかなか難しいところがあります。ユーザが設定を変更する可能性のある情報をユーザー・プリファレンスに配置するのは使い勝手が悪そうですし、結局のところ設定情報を頻繁に設定するか否かが1つの基準になるのではないかと思います。

本節までで、BlenderのUIを構築する方法が何度か出てきました。しかし幸いなことに、BlenderのUIは対象がプロパティパネルであってもユーザー・プリファレンスであっても基本的には同じような方法で構築することができます。1度覚えたことを他の場面でも使うことができるのは、実現したいことがあるたびに新たに覚えなおす必要がなくて助かりますね。UIの構築については、[2-8節](../chapter_02/08_Control_Blender_UI_1.md) から [2-10節](../chapter_02/10_Control_Blender_UI_3.md) の3節に渡って説明しているため、参考にしてみてください。

さて長くなりましたが、サンプルを使ってBlenderのAPIを紹介するのは、本節で最後になります。これまで様々なアドオンのサンプルを紹介してきましたが、いかがでしょうか？ここまで紹介したBlenderのAPIを組み合わせることで色々なことができると思えてきませんか？APIを単独で使うのではなく、組み合わせて使うことでより面白く便利な機能を提供することができます。[5章](../chapter_05/SUMMARY.md) では、これまで紹介してきたAPIを使ったサンプルをいくつか紹介していますので、参考にしてみてください。

実質最後の章にあたる [4章](../chapter_04/SUMMARY.md) では、アドオンを開発したり公開したりする時に参考になる情報を紹介します。筆者のこれまでのアドオン開発の経験から、アドオンを開発される方に知っておいて欲しいことをまとめていますので、ぜひ最後まで読んでみてください。


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* ユーザー・プリファレンスには、アドオンごとに設定や詳細情報を記述することができるUIが用意されている
* 頻繁に変更する設定をツール・シェルフやプロパティパネルに配置し、その他はユーザー・プリファレンスに配置するなど、設定内容に応じてアドオンの設定情報を配置する場所を決めよう
* ユーザー・プリファレンスにアドオンの設定情報を配置するためには、```bpy.types.AddonPreferences``` クラスを継承したアドオン設定クラスを定義する必要がある
* アドオンの設定情報はアドオン設定クラスのメンバ変数にプロパティクラスの変数として定義し、ユーザー・プリファレンスに配置する設定情報のUIは ```draw()``` メソッドで定義する
* ユーザー・プリファレンスのアドオンの設定情報は、```context.user_preferences.addons``` から参照できる
