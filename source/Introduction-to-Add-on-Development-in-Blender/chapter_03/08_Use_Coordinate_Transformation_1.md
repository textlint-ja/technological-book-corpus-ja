<div id="sect_title_img_3_8"></div>

<div id="sect_title_text"></div>

# 座標変換を活用する①

<div id="preface"></div>

###### [3-1節](01_Handle_Mouse_Click_Event.md) から [3-5節](05_Render_String_with_blf_Module.md) にかけてUIに関する話題を取り上げました。これらの解説で取り上げた内容をアドオンに組み込んでいくと、いずれ3Dビューエリアにおいてリージョン座標から3D空間の座標、またはその逆で3D空間の座標からリージョン座標のように座標変換したいと思うようになります。本節では、Blenderが提供する座標変換APIを使ったアドオンを紹介したいと思います。


## 座標変換について

筆者が初めて3Dプログラミングに挑戦した時も同じでしたが、3Dプログラミングに馴染みのない方にとって座標変換の必要性を問われてもさっぱりわからなかったりします。しかし3Dソフトや3Dソフトのアドオンを作る立場になると、どうしても座標変換を理解し使いこなせる必要が出てきます。例えば、[3-1節](01_Handle_Mouse_Click_Event.md) で紹介したように、マウスをクリックした位置の面を削除する処理を実装するためには、スクリーン上の座標から *3Dビュー* エリアの3D空間上の座標へ変更する必要があります。3Dプログラミングにおける座標変換については、世の中にすでにたくさんの解説記事や書籍があるため詳細は割愛しますが、Blenderで使われている座標変換について少し触れておきます。

Blenderは、ユーザから与えられた頂点情報（座標や法線）などをもとに3Dポリゴンを画面に表示します。この時Blenderの内部では以下の座標変換が行われています。

```sh
グローバル座標 = グローバル座標変換行列 × ローカル座標
リージョン座標 = ビューポート変換行列 × 射影変換行列 × ビュー変換行列 × グローバル座標
```

ローカル座標やグローバル座標については、おそらくBlenderをある程度使っている方であれば既に知っているかもしれません。ローカル座標は *エディットモード* 時のプロパティパネルの *トランスフォーム* の頂点で *ローカル* を選んだ時の *頂点* に表示されている座標値、グローバル座標は *グローバル* を選んだ時の *頂点* に表示されている座標値です。この時、ローカル座標に対して *オブジェクトモード* 時のプロパティパネルの *トランスフォーム* で行った変換変換処理を適用されたものがグローバル座標であることに気が付きましたでしょうか？実際にこのことを理解するために、*オブジェクトモード* でオブジェクトに座標変換した時のグローバル座標の値の変化を見てみましょう。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*エディットモード* であることを確認し、*3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *中点* の座標値を確認します。グローバル座標を確認するため、*グローバル* ボタンが選択されていることを確認します。|![3-8節 座標変換 手順1](https://dl.dropboxusercontent.com/s/h061n17rk6i64nf/coordinate_transformation_1.png "3-8節 座標変換 手順1")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オブジェクトモード* に切り替え、同じく *3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *位置* の値をX方向に+1、Y方向に-1します。|![3-8節 座標変換 手順2](https://dl.dropboxusercontent.com/s/1zex048ao9qso8y/coordinate_transformation_2.png "3-8節 座標変換 手順2")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|*エディットモード* に切り替え、*3Dビュー* エリアのプロパティパネルの *トランスフォーム* にある *頂点* 値を確認すると、Xの値が+1、Yの値が-1となっていることが確認できます。|![3-8節 座標変換 手順3](https://dl.dropboxusercontent.com/s/6oj5tk3ep1h77x9/coordinate_transformation_3.png "3-8節 座標変換 手順3")|
|---|---|---|

<div id="process_sep"></div>

---


<div id="process_start_end"></div>

---

このように、ローカル座標に対して *オブジェクトモード* で行った変換処理を適用することで、グローバル座標を得られることが理解できたと思います。グローバル座標からリージョン座標への変換処理についてもBlender内のデータを使って行うことができますが、あまり直感的ではないのとBlenderが提供するAPIがこの変換処理を勝手に行ってくれるので、ここでは省略します。実際に本節のサンプルを理解するためには、ローカル座標・グローバル座標・リージョン座標のみ理解しておけば問題ないです。ただし、気になる方もいると思うので、[3-9節](09_Use_Coordinate_Transformation_2.md) の一番最後に自力でローカル座標からリージョン座標へ変換する方法を紹介します。興味のある方は確認してみてください。


## 作成するアドオンの仕様

* *3Dビュー* エリアの選択されているオブジェクトについて、オブジェクトの中心座標の画面上での移動の軌跡を表示する


## アドオンを作成する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考にして以下のソースコードをテキスト・エディタに入力し、ファイル名 ```sample_3-8.py``` として保存してください。

[import](../../sample/src/chapter_03/sample_3-8.py)

## アドオンを使用する

### アドオンを有効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に作成したアドオンを有効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が有効化されました。
```

<div id="sidebyside"></div>

|また、*3Dビュー* エリアのプロパティパネルに *オブジェクトの軌跡表示* が追加されていることを確認します。|![3-8節 アドオン有効化](https://dl.dropboxusercontent.com/s/3aighvabzty5i3h/enable_add-on.png "3-8節 アドオン有効化")|
|---|---|



### アドオンの機能を使用する

以下の手順に従って、作成したアドオンの機能を使ってみます。

<div id="process_title"></div>

##### Work

<div id="process"></div>

|<div id="box">1</div>|*3Dビュー* エリアのプロパティパネルに追加された *オブジェクトの軌跡表示* の *開始* ボタンをクリックします。|![3-8節 アドオンの使用 手順1](https://dl.dropboxusercontent.com/s/zin86hpouityhpu/use_add-on_1.png "3-8節 アドオンの使用 手順1")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">2</div>|*オブジェクトモード* で選択中のオブジェクトを移動すると、オブジェクトの中心座標から変換したリージョン座標の位置に四角形が一定期間表示されます。|![3-8節 アドオンの使用 手順2](https://dl.dropboxusercontent.com/s/lxyu2qkkrwd9bns/use_add-on_2.png "3-8節 アドオンの使用 手順2")|
|---|---|---|

<div id="process_sep"></div>

---

<div id="process"></div>

|<div id="box">3</div>|*3Dビュー* エリアのプロパティパネル *オブジェクトの軌跡表示* の *終了* ボタンをクリックすると、軌跡が表示されなくなります。|![3-8節 アドオンの使用 手順3](https://dl.dropboxusercontent.com/s/u2e109sfe5yljd0/use_add-on_3.png "3-8節 アドオンの使用 手順3")|
|---|---|---|



<div id="process_start_end"></div>

---


### アドオンを無効化する

[1-5節](../chapter_01/05_Install_own_Add-on.md) を参考に有効化したアドオンを無効化すると、コンソールウィンドウに文字列が出力されます。

```sh
サンプル3-8: アドオン「サンプル3-8」が無効化されました。
```


## ソースコードの解説

本節では座標変換の処理以外に ```bgl``` モジュールを利用した図形描画処理を行っています。```bgl``` モジュールを利用した図形描画処理については [3-4節](04_Use_API_for_OpenGL.md) を参照してください。本節では、座標変換処理に関係する処理についてのみ説明します。

### bpy_extraモジュール

Blenderが提供するAPIの大半は ```bpy``` モジュールとして提供され、ほとんどのアドオン開発者はこのモジュールを使ってアドオンを開発することが多いと思います。しかし、```bpy``` モジュールは基本的な機能しか提供しないため、使いづらいと感じることもあるかもしれません。このためBlenderは、開発者が比較的多く使うと想定される便利なAPI群を ```bpy_extra``` モジュールとして提供しています。```bpy_extra``` モジュールを利用することで面倒な処理を1から実装することなく実現できるため、機能を実装する際に面倒だと思ったら ```bpy_extra``` モジュールで実現したい処理がAPIとして提供されていないかを確認してみましょう。

次に示すように、```bpy_extra``` モジュールは複数のサブモジュールから構成されています。

|サブモジュール名|概要|
|---|---|
|```anim_utils```|アニメーション関連の便利API|
|```object_utils```|オブジェクト操作関連の便利API|
|```io_utils```|インポータ/エクスポータ向けの便利APIやファイルパスに関する便利API|
|```image_utils```|画像ファイルの読込みに関する便利API|
|```keyconfig_utils```|キーコンフィグ関連の便利API|
|```mesh_utils```|メッシュ型オブジェクトに関する便利API|
|```view3d_utils```|3Dビューエリア上で座標変換を容易に行うためのAPI|


本節で使用している座標変換のAPIを利用するためには、```bpy_extra``` モジュールの ```view3d_utils``` をインポートする必要があります。

[import:"import_view3d_utils", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)


### オブジェクトの軌跡を表示する

選択中のオブジェクトの軌跡を表示するためには、次の手順に従います。

1. オブジェクトの位置座標を取得する
2. オブジェクトの位置座標をリージョン座標に変換する
3. 古い位置情報を削除する
4. 変換したリージョン座標に四角形を描画する

最初に1と2の処理を行うコードを次に示します。

[import:"loc_to_region", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

オブジェクトの位置座標は、```bpy.data.objects``` の各要素から取得できるオブジェクトデータの ```location``` メンバ変数から取得することができます。続いて、オブジェクトの位置座標をリージョン座標に座標変換します。この座標変換を1から実装するとなると、カメラのビュー行列などを用いて行列計算を行う必要があります。幸いなことに ```bpy_extra``` モジュールの ```view3d_utils``` サブモジュールが提供するAPIを利用することで、この処理を比較的簡単な方法で実現することができます。本節のサンプルでは、オブジェクトの位置座標をリージョン座標に変換するために ```view3d_utils.location_3d_to_region_2d()``` 関数を呼び出します。```view3d_utils.location_3d_to_region_2d()``` 関数の引数を以下に示します。

|引数|意味|
|---|---|
|第1引数|座標変換対象のリージョン|
|第2引数|座標変換対象の3Dリージョンデータ|
|第3引数|3D空間の座標|

3Dリージョンデータは、スペースの ```region_3d``` メンバ変数から取得することができます。座標変換対象のリージョンとスペースは ```get_region_space``` スタティックメソッドで取得します。本節のサンプルでは、*3Dビュー* エリアのウィンドウリージョンを座標変換対象としたいため、リージョン ```WINDOW``` とスペース ```VIEW_3D``` を取得しています。```view3d_utils.location_3d_to_region_2d()``` 関数の第1引数に取得したリージョンを、第2引数にスペースの ```region_3d``` メンバ変数を、第3引数にオブジェクトデータの ```location``` メンバ変数を指定して呼び出すことで、座標変換後のリージョン座標を取得することができます。取得した情報は、```self.loc_history``` メンバ変数に保存します。```self.loc_history``` の各要素には、選択された全てのオブジェクトの位置情報を配列として保存されます。

保存した位置情報は古くなったら削除しないと、画面が四角形で埋め尽くされてしまいます。このため、次の処理により位置情報の履歴が100以上になった時に最も古い位置情報を削除しています（3の処理）。

[import:"delete_oldest_loc", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)

最後に、変換したリージョン座標に四角形を描画します（4の処理）。四角形の描画は ```bgl``` モジュールを使い、[3-4節](04_Use_API_for_OpenGL.md) で説明した方法で描画します。

[import:"render_rect", unindent:"true"](../../sample_raw/src/chapter_03/sample_3-8.py)



## まとめ

本節では、*3Dビュー* 上の座標からリージョン座標へ変換するアドオンのサンプルを紹介しました。```view3d_utils``` サブモジュールを使用することにより、自前での座標変換処理の実装が不要であることが理解できたのではないでしょうか。このように、```bpy_extra``` には自前で行うには面倒な処理を、簡単な手順で実現できるAPIが揃っています。提供されているAPIの数は少ないですが、```bpy_extra``` モジュールでは座標変換に限らず便利なAPIを提供しているため、一度目を通しておくと良いと思います。

本節では、*3Dビュー* 上の座標からリージョン座標へ変換しましたが、[3-9節](09_Use_Coordinate_Transformation_2.md) ではその逆の座標変換である、リージョン座標から *3Dビュー* 上の座標へ変換する方法を説明します。


<div id="point"></div>

### ポイント

<div id="point_item"></div>

* Blenderは3Dポリゴンを画面に表示するまでに、グローバル座標変換→ビュー変換→射影変換→ビューポート変換を行なってローカル座標からリージョン座標へ座標変換する
* ```bpy_extra``` モジュールは、 ```bpy``` モジュールだけで処理を実装すると面倒な処理を、開発者がAPI呼び出しだけで簡単に実現できるようにした、APIの集まりである
* ```bpy_extra``` モジュールのサブモジュールである ```view3d_utils``` サブモジュールは、*3Dビュー* エリア上で座標変換を行うためのAPIを提供する
